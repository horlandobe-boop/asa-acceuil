<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mikotse - Plateforme de Travail</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #64748b;
      --accent: #f1f5f9;
      --background: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s ease-in-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
      font-size: 16px;
    }

    /* Pages */
    .page {
      display: none;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .page.active {
      display: block;
    }

    /* Auth Pages */
    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
    }

    .auth-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .auth-logo {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .auth-subtitle {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .auth-btn {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 1rem;
    }

    .auth-btn:hover {
      background: var(--primary-dark);
    }

    .auth-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .auth-link:hover {
      text-decoration: underline;
    }

    /* Payment Page */
    .payment-container {
      max-width: 500px;
      margin: 2rem auto;
    }

    .payment-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
    }

    .payment-plan {
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .payment-plan.selected {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .plan-name {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .plan-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .plan-features {
      list-style: none;
      margin: 1rem 0;
    }

    .plan-features li {
      padding: 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .plan-features i {
      color: var(--success);
    }

    /* Bank Info */
    .bank-info {
      background: var(--accent);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--primary);
    }

    .bank-info-title {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .bank-detail {
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
    }

    .bank-detail-label {
      font-weight: 500;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .nav-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Main Layout */
    .main-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.25rem;
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 1.5rem;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }

    /* Profile Section */
    .profile-section {
      position: sticky;
      top: 100px;
      height: fit-content;
    }

    .profile-card {
      text-align: center;
    }

    .profile-picture {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--primary-light);
      margin: 0 auto 1rem;
      display: block;
      cursor: pointer;
    }

    .profile-name {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .profile-bio {
      color: var(--text-muted);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .profile-stats {
      display: flex;
      justify-content: space-around;
      margin: 1rem 0;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .edit-profile-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      width: 100%;
      margin-top: 1rem;
    }

    .edit-profile-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    /* Videos Section */
    .videos-section {
      margin-bottom: 2rem;
    }

    .video-card {
      margin-bottom: 2rem;
    }

    .video-container {
      width: 100%;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      background: #000;
      position: relative;
      padding-top: 56.25%; /* 16:9 Aspect Ratio */
    }

    .video-player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
    }

    .video-actions {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .video-action {
      background: var(--accent);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .video-action:hover {
      background: var(--primary-light);
    }

    .video-action.active {
      color: var(--primary);
    }

    .download-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .download-btn:hover {
      background: #0da271;
    }

    /* Registration Button */
    .registration-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .registration-btn:hover {
      background: var(--primary-dark);
    }

    /* Chat Sections */
    .chat-section {
      margin-bottom: 2rem;
    }

    .chat-container {
      height: 400px;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    .chat-header {
      padding: 1rem;
      background: var(--primary);
      color: white;
      border-radius: var(--radius) var(--radius) 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .online-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      display: flex;
      gap: 0.75rem;
      animation: fadeIn 0.3s ease-out;
    }

    .message.own {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .message-content {
      max-width: 70%;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .message-author {
      font-weight: 600;
      font-size: 0.875rem;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .message-text {
      background: var(--accent);
      padding: 0.75rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
    }

    .message.own .message-text {
      background: var(--primary-light);
    }

    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }

    .chat-input-form {
      display: flex;
      gap: 0.75rem;
    }

    .chat-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      resize: none;
    }

    .send-message-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .send-message-btn:hover {
      background: var(--primary-dark);
    }

    /* Contacts List */
    .contacts-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .contact {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: var(--transition);
    }

    .contact:hover {
      background: var(--accent);
    }

    .contact.active {
      background: var(--primary-light);
    }

    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .contact-info {
      flex: 1;
    }

    .contact-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .contact-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-online {
      color: var(--success);
    }

    .status-offline {
      color: var(--text-muted);
    }

    /* Notifications */
    .notifications-section {
      position: sticky;
      top: 100px;
    }

    .notification-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .notification-item:hover {
      background: var(--accent);
    }

    .notification-item.unread {
      background: var(--primary-light);
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
    }

    .notification-content {
      flex: 1;
    }

    .notification-text {
      margin-bottom: 0.25rem;
    }

    .notification-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Admin Panel */
    .admin-panel {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .admin-section {
      margin-bottom: 2rem;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .admin-table th {
      background: var(--accent);
      font-weight: 600;
    }

    .admin-table tr:hover {
      background: var(--accent);
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pending {
      background: var(--warning);
      color: white;
    }

    .status-confirmed {
      background: var(--success);
      color: white;
    }

    .status-expired {
      background: var(--error);
      color: white;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Notification Badge */
    .notification-badge {
      background: var(--error);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      position: absolute;
      top: -5px;
      right: -5px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr 2fr;
      }
      
      .notifications-section {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        margin: 1rem auto;
        padding: 0 1rem;
      }
      
      .profile-section {
        position: static;
      }
      
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .nav-container {
        width: 100%;
        justify-content: space-between;
      }
      
      .chat-container {
        height: 300px;
      }
      
      .video-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Pages -->
  <div id="signupPage" class="page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-briefcase"></i>
        </div>
        <h1 class="auth-title">Inscription</h1>
        <p class="auth-subtitle">Rejoignez notre plateforme de travail</p>
        
        <form id="signupForm">
          <div class="form-group">
            <label class="form-label">Nom complet</label>
            <input type="text" class="form-input" id="signupName" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="signupEmail" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Mot de passe</label>
            <input type="password" class="form-input" id="signupPassword" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Date de naissance</label>
            <input type="date" class="form-input" id="signupBirthdate" required>
          </div>
          
          <button type="submit" class="auth-btn">S'inscrire</button>
        </form>
        
        <p>Déjà un compte? <a href="#" class="auth-link" onclick="showPage('loginPage')">Se connecter</a></p>
      </div>
    </div>
  </div>

  <div id="loginPage" class="page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-briefcase"></i>
        </div>
        <h1 class="auth-title">Connexion</h1>
        <p class="auth-subtitle">Accédez à votre compte</p>
        
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="loginEmail" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Mot de passe</label>
            <input type="password" class="form-input" id="loginPassword" required>
          </div>
          
          <button type="submit" class="auth-btn">Se connecter</button>
        </form>
        
        <p>Pas de compte? <a href="#" class="auth-link" onclick="showPage('signupPage')">S'inscrire</a></p>
      </div>
    </div>
  </div>

  <div id="paymentPage" class="page">
    <div class="payment-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-credit-card"></i>
        </div>
        <h1 class="auth-title">Choisissez votre plan</h1>
        <p class="auth-subtitle">Sélectionnez le forfait qui vous convient</p>
        
        <div class="bank-info">
          <h3 class="bank-info-title">Informations de paiement</h3>
          <div class="bank-detail">
            <span class="bank-detail-label">Numéro de compte:</span>
            <span>0323911654</span>
          </div>
          <div class="bank-detail">
            <span class="bank-detail-label">Nom:</span>
            <span>RAVELOMANANTSOA URMIN</span>
          </div>
          <p style="margin-top: 1rem; font-size: 0.9rem;">
            Veuillez effectuer le virement avant de cliquer sur "J'ai payé"
          </p>
        </div>
        
        <div class="payment-plans">
          <div class="payment-plan" onclick="selectPlan('basic')">
            <h3 class="plan-name">Basique</h3>
            <div class="plan-price">10,000 Ar/mois</div>
            <ul class="plan-features">
              <li><i class="fas fa-check"></i> Accès aux vidéos de base</li>
              <li><i class="fas fa-check"></i> Chat public</li>
              <li><i class="fas fa-times"></i> Chat privé</li>
            </ul>
          </div>
          
          <div class="payment-plan" onclick="selectPlan('premium')">
            <h3 class="plan-name">Premium</h3>
            <div class="plan-price">25,000 Ar/mois</div>
            <ul class="plan-features">
              <li><i class="fas fa-check"></i> Tous les avantages Basique</li>
              <li><i class="fas fa-check"></i> Chat privé illimité</li>
              <li><i class="fas fa-check"></i> Téléchargement des vidéos</li>
            </ul>
          </div>
        </div>
        
        <button class="auth-btn" id="paymentBtn" onclick="processPayment()">J'ai payé</button>
      </div>
    </div>
  </div>

  <div id="pendingPage" class="page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-clock"></i>
        </div>
        <h1 class="auth-title">Paiement en attente</h1>
        <p class="auth-subtitle">Votre paiement est en cours de traitement</p>
        
        <div style="text-align: center; margin: 2rem 0;">
          <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
        </div>
        
        <p>Vous serez redirigé automatiquement une fois le paiement confirmé par l'administrateur.</p>
      </div>
    </div>
  </div>

  <div id="expiredPage" class="page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h1 class="auth-title">Abonnement expiré</h1>
        <p class="auth-subtitle">Votre abonnement de 30 jours a expiré</p>
        
        <div style="text-align: center; margin: 2rem 0;">
          <i class="fas fa-calendar-times" style="font-size: 3rem; color: var(--warning);"></i>
        </div>
        
        <p>Veuillez renouveler votre abonnement pour continuer à utiliser la plateforme.</p>
        
        <button class="auth-btn" onclick="showPage('paymentPage')">Mettre à jour le paiement</button>
      </div>
    </div>
  </div>

  <div id="adminPage" class="page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-user-shield"></i>
        </div>
        <h1 class="auth-title">Accès Administrateur</h1>
        <p class="auth-subtitle">Entrez le code d'accès administrateur</p>
        
        <form id="adminLoginForm">
          <div class="form-group">
            <label class="form-label">Code d'accès</label>
            <input type="password" class="form-input" id="adminCode" required>
          </div>
          
          <button type="submit" class="auth-btn">Accéder</button>
        </form>
        
        <p><a href="#" class="auth-link" onclick="showPage('loginPage')">Retour à la connexion utilisateur</a></p>
      </div>
    </div>
  </div>

  <div id="adminPanelPage" class="page">
    <header>
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-user-shield"></i>
          <span>Administration Mikotse</span>
        </div>
        
        <div class="nav-container">
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Déconnexion Admin
          </a>
        </div>
      </div>
    </header>

    <div class="main-container">
      <div class="admin-panel">
        <h2 style="margin-bottom: 1.5rem;">Panneau d'administration</h2>
        
        <div class="admin-section">
          <h3 class="card-title">Gestion des paiements</h3>
          <div class="card">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Plan</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paymentsTable">
                <!-- Payments will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="admin-section">
          <h3 class="card-title">Gestion des vidéos</h3>
          <div class="card">
            <form id="videoForm">
              <div class="form-group">
                <label class="form-label">1. Titre de la vidéo *</label>
                <input type="text" class="form-input" id="videoTitle" required placeholder="Entrez le titre de la vidéo">
              </div>
              
              <div class="form-group">
                <label class="form-label">2. Lien de visionnage direct *</label>
                <input type="url" class="form-input" id="videoUrl" required placeholder="https://example.com/video.mp4">
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                  Ce lien sera affiché directement sur la page pour visionner la vidéo
                </small>
              </div>

              <div class="form-group">
                <label class="form-label">Lien de téléchargement (optionnel)</label>
                <input type="url" class="form-input" id="videoDownloadUrl" placeholder="https://example.com/video.zip">
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                  Lien pour télécharger la vidéo (optionnel)
                </small>
              </div>
              
              <div class="form-group">
                <label class="form-label">3. Lien d'inscription (optionnel)</label>
                <input type="url" class="form-input" id="videoRegistrationUrl" placeholder="https://example.com/register">
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                  Ce lien sera affiché sous forme de bouton sous la vidéo
                </small>
              </div>
              
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="videoDescription" rows="3" placeholder="Description de la vidéo..."></textarea>
              </div>
              
              <div class="form-group">
                <label class="form-label">Catégorie</label>
                <select class="form-input" id="videoCategory">
                  <option value="formation">Formation</option>
                  <option value="tutoriel">Tutoriel</option>
                  <option value="demonstration">Démonstration</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <button type="submit" class="auth-btn">Ajouter la vidéo</button>
            </form>
            
            <div style="margin-top: 2rem;">
              <h4>Vidéos existantes</h4>
              <div id="adminVideosList">
                <!-- Existing videos will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="homePage" class="page">
    <header>
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-briefcase"></i>
          <span>Mikotse</span>
        </div>
        
        <div class="nav-container">
          <a class="nav-link active" href="#profile">
            <i class="fas fa-user"></i>
            Profil
          </a>
          <a class="nav-link" href="#videos">
            <i class="fas fa-video"></i>
            Travaux
          </a>
          <a class="nav-link" href="#chat">
            <i class="fas fa-comments"></i>
            Chat Public
          </a>
          <a class="nav-link" href="#private-chat">
            <i class="fas fa-lock"></i>
            Chat Privé
          </a>
          <a class="nav-link" href="#notifications" style="position: relative;">
            <i class="fas fa-bell"></i>
            Notifications
            <span class="notification-badge" id="notificationCount">0</span>
          </a>
          <a class="nav-link" href="#" onclick="showAdminLogin()">
            <i class="fas fa-user-shield"></i>
            Admin
          </a>
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Déconnexion
          </a>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- Left Sidebar - Profile -->
      <aside class="profile-section">
        <div class="card profile-card">
          <img src="https://via.placeholder.com/120" alt="Profile Picture" class="profile-picture" id="profilePicture">
          <h2 class="profile-name" id="profileName">Utilisateur</h2>
          <p class="profile-bio" id="profileBio">Aucune biographie</p>
          
          <div class="profile-stats">
            <div class="stat">
              <div class="stat-value" id="videoCount">0</div>
              <div class="stat-label">Vidéos</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="contactCount">0</div>
              <div class="stat-label">Contacts</div>
            </div>
          </div>
          
          <div class="profile-stats">
            <div class="stat">
              <div class="stat-value" id="daysRemaining">30</div>
              <div class="stat-label">Jours restants</div>
            </div>
          </div>
          
          <button class="edit-profile-btn" onclick="editProfile()">
            <i class="fas fa-edit"></i>
            Modifier le profil
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Profile Edit Section -->
        <section id="profileSection" class="card">
          <div class="card-header">
            <h3 class="card-title">Modifier le profil</h3>
          </div>
          
          <form id="profileForm">
            <div class="form-group">
              <label class="form-label">Photo de profil</label>
              <input type="file" class="form-input" id="profilePhoto" accept="image/*">
            </div>
            
            <div class="form-group">
              <label class="form-label">Nom complet</label>
              <input type="text" class="form-input" id="editName">
            </div>
            
            <div class="form-group">
              <label class="form-label">Date de naissance</label>
              <input type="date" class="form-input" id="editBirthdate">
            </div>
            
            <div class="form-group">
              <label class="form-label">Biographie</label>
              <textarea class="form-input" id="editBio" rows="3"></textarea>
            </div>
            
            <button type="submit" class="auth-btn">Enregistrer</button>
          </form>
        </section>

        <!-- Videos Section -->
        <section id="videosSection" class="videos-section" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Vidéos de travail</h3>
            </div>
            
            <div id="videosList">
              <!-- Videos will be loaded here -->
            </div>
          </div>
        </section>

        <!-- Public Chat Section -->
        <section id="publicChatSection" class="chat-section" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Chat Public</h3>
              <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="onlineCount">0</span> en ligne
              </div>
            </div>
            
            <div class="chat-container">
              <div class="chat-messages" id="publicChatMessages"></div>
              <div class="chat-input-container">
                <form class="chat-input-form" id="publicChatForm">
                  <input type="text" class="chat-input" id="publicChatInput" placeholder="Tapez votre message...">
                  <button type="submit" class="send-message-btn">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </section>

        <!-- Private Chat Section -->
        <section id="privateChatSection" class="chat-section" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Chat Privé</h3>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; height: 400px;">
              <div class="contacts-list" id="contactsList">
                <!-- Contacts will be loaded here -->
              </div>
              
              <div class="chat-container">
                <div class="chat-messages" id="privateChatMessages"></div>
                <div class="chat-input-container">
                  <form class="chat-input-form" id="privateChatForm">
                    <input type="text" class="chat-input" id="privateChatInput" placeholder="Tapez votre message...">
                    <button type="submit" class="send-message-btn">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- Right Sidebar - Notifications -->
      <aside class="notifications-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Notifications</h3>
          </div>
          
          <div id="notificationsList">
            <!-- Notifications will be loaded here -->
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtq50XttR1S-f9RMo0otxx5jrRiY30QEE",
      authDomain: "miasamada-4f90a.firebaseapp.com",
      databaseURL: "https://miasamada-4f90a-default-rtdb.firebaseio.com",
      projectId: "miasamada-4f90a",
      storageBucket: "miasamada-4f90a.firebasestorage.app",
      messagingSenderId: "341483369374",
      appId: "1:341483369374:web:721451eb0df21d4ef45c8f",
      measurementId: "G-XTH1TCS8H4"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Global variables
    let currentUser = null;
    let selectedPlan = null;
    let currentChatContact = null;
    const ADMIN_CODE = "080600";

    // Initialize the app
    function init() {
      setupEventListeners();
      checkAuthState();
    }

    // Check authentication state
    function checkAuthState() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          loadUserData(user.uid);
          checkPaymentStatus(user.uid);
        } else {
          showPage('signupPage');
        }
      });
    }

    // Load user data from Firebase
    function loadUserData(userId) {
      const userRef = db.ref('users/' + userId);
      userRef.on('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          updateProfileUI(userData);
        }
      });
    }

    // Check payment status
    function checkPaymentStatus(userId) {
      const paymentRef = db.ref('payments/' + userId);
      paymentRef.on('value', (snapshot) => {
        const paymentData = snapshot.val();
        if (paymentData && paymentData.status === 'confirmed') {
          // Check if subscription is still valid (30 days)
          const confirmedAt = paymentData.confirmedAt;
          const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
          const now = Date.now();
          
          if (now - confirmedAt < thirtyDaysInMs) {
            showPage('homePage');
            setupHomePage();
            updateDaysRemaining(confirmedAt);
          } else {
            showPage('expiredPage');
          }
        } else if (paymentData && paymentData.status === 'pending') {
          showPage('pendingPage');
        } else {
          showPage('paymentPage');
        }
      });
    }

    // Update days remaining in subscription
    function updateDaysRemaining(confirmedAt) {
      const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
      const now = Date.now();
      const elapsed = now - confirmedAt;
      const remainingMs = thirtyDaysInMs - elapsed;
      const daysRemaining = Math.ceil(remainingMs / (24 * 60 * 60 * 1000));
      
      document.getElementById('daysRemaining').textContent = Math.max(0, daysRemaining);
    }

    // Show specific page
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    // Select payment plan
    function selectPlan(plan) {
      selectedPlan = plan;
      document.querySelectorAll('.payment-plan').forEach(planEl => {
        planEl.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }

    // Process payment
    function processPayment() {
      if (!selectedPlan) {
        alert('Veuillez sélectionner un plan');
        return;
      }

      if (!currentUser) {
        alert('Utilisateur non connecté');
        return;
      }

      const paymentRef = db.ref('payments/' + currentUser.uid);
      paymentRef.set({
        plan: selectedPlan,
        amount: selectedPlan === 'basic' ? 10000 : 25000,
        status: 'pending',
        createdAt: Date.now(),
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Utilisateur'
      });

      showPage('pendingPage');
    }

    // Setup event listeners
    function setupEventListeners() {
      // Auth forms
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
      document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
      document.getElementById('videoForm').addEventListener('submit', handleAddVideo);

      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const target = e.currentTarget.getAttribute('href').substring(1);
          showSection(target);
        });
      });

      // Chat forms
      document.getElementById('publicChatForm').addEventListener('submit', handlePublicChat);
      document.getElementById('privateChatForm').addEventListener('submit', handlePrivateChat);
    }

    // Handle signup
    function handleSignup(e) {
      e.preventDefault();
      
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const birthdate = document.getElementById('signupBirthdate').value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          
          // Save user data to Firebase
          const userRef = db.ref('users/' + user.uid);
          userRef.set({
            name: name,
            email: email,
            birthdate: birthdate,
            profilePicture: 'https://via.placeholder.com/120',
            bio: 'Aucune biographie',
            createdAt: Date.now()
          });

          showPage('paymentPage');
        })
        .catch((error) => {
          alert('Erreur lors de l\'inscription: ' + error.message);
        });
    }

    // Handle login
    function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // User signed in
          currentUser = userCredential.user;
          checkPaymentStatus(currentUser.uid);
        })
        .catch((error) => {
          alert('Erreur lors de la connexion: ' + error.message);
        });
    }

    // Handle admin login
    function handleAdminLogin(e) {
      e.preventDefault();
      
      const code = document.getElementById('adminCode').value;
      
      if (code === ADMIN_CODE) {
        showPage('adminPanelPage');
        loadAdminData();
      } else {
        alert('Code d\'accès incorrect');
      }
    }

    // Handle profile update
    function handleProfileUpdate(e) {
      e.preventDefault();
      
      if (!currentUser) return;

      const name = document.getElementById('editName').value;
      const birthdate = document.getElementById('editBirthdate').value;
      const bio = document.getElementById('editBio').value;
      const photoFile = document.getElementById('profilePhoto').files[0];

      const updates = {
        name: name,
        birthdate: birthdate,
        bio: bio
      };

      if (photoFile) {
        // Upload profile picture
        const storageRef = storage.ref('profilePictures/' + currentUser.uid);
        storageRef.put(photoFile)
          .then((snapshot) => snapshot.ref.getDownloadURL())
          .then((url) => {
            updates.profilePicture = url;
            saveProfileUpdates(updates);
          });
      } else {
        saveProfileUpdates(updates);
      }
    }

    // Save profile updates to Firebase
    function saveProfileUpdates(updates) {
      const userRef = db.ref('users/' + currentUser.uid);
      userRef.update(updates)
        .then(() => {
          alert('Profil mis à jour avec succès!');
        })
        .catch((error) => {
          alert('Erreur lors de la mise à jour: ' + error.message);
        });
    }

    // Update profile UI
    function updateProfileUI(userData) {
      document.getElementById('profileName').textContent = userData.name || 'Utilisateur';
      document.getElementById('profileBio').textContent = userData.bio || 'Aucune biographie';
      document.getElementById('profilePicture').src = userData.profilePicture || 'https://via.placeholder.com/120';
      
      if (document.getElementById('editName')) {
        document.getElementById('editName').value = userData.name || '';
        document.getElementById('editBirthdate').value = userData.birthdate || '';
        document.getElementById('editBio').value = userData.bio || '';
      }
    }

    // Show specific section in home page
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('main > section').forEach(section => {
        section.style.display = 'none';
      });

      // Show selected section
      document.getElementById(sectionId + 'Section').style.display = 'block';

      // Update active nav link
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[href="#${sectionId}"]`).classList.add('active');

      // Load section data
      switch(sectionId) {
        case 'videos':
          loadVideos();
          break;
        case 'chat':
          loadPublicChat();
          break;
        case 'private-chat':
          loadPrivateChat();
          break;
        case 'notifications':
          loadNotifications();
          break;
      }
    }

    // Setup home page
    function setupHomePage() {
      showSection('profile');
      loadVideos();
      loadPublicChat();
      loadPrivateChat();
      loadNotifications();
      setupRealtimeListeners();
    }

    // Load videos from Firebase - CORRIGÉ POUR AFFICHER LA VIDÉO DIRECTEMENT
    function loadVideos() {
      const videosRef = db.ref('videos').orderByChild('createdAt');
      videosRef.on('value', (snapshot) => {
        const videos = snapshot.val();
        const videosList = document.getElementById('videosList');
        videosList.innerHTML = '';

        if (!videos) {
          videosList.innerHTML = '<p>Aucune vidéo disponible</p>';
          return;
        }

        Object.entries(videos).forEach(([videoId, video]) => {
          const videoElement = document.createElement('div');
          videoElement.className = 'video-card card';
          
          // Déterminer le type de contenu vidéo
          let videoHtml = '';
          if (video.url.includes('.mp4') || video.url.includes('.webm') || video.url.includes('.ogg')) {
            // C'est un fichier vidéo direct
            videoHtml = `
              <div class="video-container">
                <video class="video-player" controls>
                  <source src="${video.url}" type="video/mp4">
                  Votre navigateur ne supporte pas la lecture de vidéos.
                </video>
              </div>
            `;
          } else if (video.url.includes('youtube.com') || video.url.includes('youtu.be')) {
            // C'est une vidéo YouTube
            let videoId = video.url.split('v=')[1];
            if (!videoId && video.url.includes('youtu.be')) {
              videoId = video.url.split('/').pop();
            }
            videoHtml = `
              <div class="video-container">
                <iframe class="video-player" 
                  src="https://www.youtube.com/embed/${videoId}" 
                  frameborder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen>
                </iframe>
              </div>
            `;
          } else if (video.url.includes('vimeo.com')) {
            // C'est une vidéo Vimeo
            const videoId = video.url.split('/').pop();
            videoHtml = `
              <div class="video-container">
                <iframe class="video-player" 
                  src="https://player.vimeo.com/video/${videoId}" 
                  frameborder="0" 
                  allow="autoplay; fullscreen; picture-in-picture" 
                  allowfullscreen>
                </iframe>
              </div>
            `;
          } else {
            // Autre type de lien - utiliser une iframe générique
            videoHtml = `
              <div class="video-container">
                <iframe class="video-player" 
                  src="${video.url}" 
                  frameborder="0" 
                  allowfullscreen>
                </iframe>
              </div>
            `;
          }

          videoElement.innerHTML = `
            <h4>${escapeHtml(video.title)}</h4>
            ${videoHtml}
            <p>${escapeHtml(video.description || '')}</p>
            <div class="video-actions">
              <button class="video-action" onclick="likeVideo('${videoId}')">
                <i class="fas fa-thumbs-up"></i>
                <span>${video.likes || 0}</span>
              </button>
              <button class="video-action" onclick="commentOnVideo('${videoId}')">
                <i class="fas fa-comment"></i>
                Commenter
              </button>
              ${video.downloadUrl ? 
                `<button class="download-btn" onclick="downloadVideo('${video.downloadUrl}', '${video.title}')">
                  <i class="fas fa-download"></i>
                  Télécharger
                </button>` : 
                `<button class="download-btn" onclick="downloadVideo('${video.url}', '${video.title}')">
                  <i class="fas fa-download"></i>
                  Télécharger
                </button>`
              }
              ${video.registrationUrl ? 
                `<a href="${video.registrationUrl}" target="_blank" class="registration-btn">
                  <i class="fas fa-user-plus"></i>
                  S'inscrire
                </a>` : 
                ''
              }
            </div>
            <div id="comments-${videoId}"></div>
          `;
          videosList.appendChild(videoElement);

          // Load comments for this video
          loadComments(videoId);
        });

        document.getElementById('videoCount').textContent = Object.keys(videos).length;
      });
    }

    // Load comments for a video
    function loadComments(videoId) {
      const commentsRef = db.ref(`comments/${videoId}`);
      commentsRef.on('value', (snapshot) => {
        const comments = snapshot.val();
        const commentsContainer = document.getElementById(`comments-${videoId}`);
        
        if (!comments) {
          commentsContainer.innerHTML = '<p>Aucun commentaire</p>';
          return;
        }

        let commentsHTML = '<div style="margin-top: 1rem;"><strong>Commentaires:</strong>';
        Object.values(comments).forEach(comment => {
          commentsHTML += `
            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
              <strong>${escapeHtml(comment.authorName)}:</strong> ${escapeHtml(comment.text)}
            </div>
          `;
        });
        commentsHTML += '</div>';
        commentsContainer.innerHTML = commentsHTML;
      });
    }

    // Like a video
    function likeVideo(videoId) {
      if (!currentUser) return;

      const likeRef = db.ref(`videos/${videoId}/likes`);
      likeRef.transaction((currentLikes) => {
        return (currentLikes || 0) + 1;
      });
    }

    // Comment on a video
    function commentOnVideo(videoId) {
      if (!currentUser) return;

      const commentText = prompt('Entrez votre commentaire:');
      if (!commentText) return;

      const commentRef = db.ref(`comments/${videoId}`).push();
      commentRef.set({
        text: commentText,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || 'Utilisateur',
        createdAt: Date.now()
      });
    }

    // Download video
    function downloadVideo(url, title) {
      const a = document.createElement('a');
      a.href = url;
      a.download = title + '.mp4';
      a.click();
    }

    // Load public chat
    function loadPublicChat() {
      const chatRef = db.ref('publicChat').orderByChild('timestamp').limitToLast(50);
      chatRef.on('value', (snapshot) => {
        const messages = snapshot.val();
        const messagesContainer = document.getElementById('publicChatMessages');
        messagesContainer.innerHTML = '';

        if (!messages) return;

        Object.entries(messages).forEach(([messageId, message]) => {
          renderPublicMessage(messageId, message);
        });

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });

      // Update online users count
      const onlineRef = db.ref('onlineUsers');
      onlineRef.on('value', (snapshot) => {
        const onlineUsers = snapshot.val() || {};
        document.getElementById('onlineCount').textContent = Object.keys(onlineUsers).length;
      });
    }

    // Render public chat message
    function renderPublicMessage(messageId, message) {
      const messagesContainer = document.getElementById('publicChatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = `message ${message.authorId === currentUser.uid ? 'own' : ''}`;
      messageElement.innerHTML = `
        <img src="${message.authorProfilePicture || 'https://via.placeholder.com/36'}" 
             alt="Profile" class="message-avatar">
        <div class="message-content">
          <div class="message-header">
            <span class="message-author">${escapeHtml(message.authorName)}</span>
            <span class="message-time">${formatTime(message.timestamp)}</span>
          </div>
          <div class="message-text">${escapeHtml(message.text)}</div>
        </div>
      `;
      messagesContainer.appendChild(messageElement);
    }

    // Handle public chat message
    function handlePublicChat(e) {
      e.preventDefault();
      
      if (!currentUser) return;

      const input = document.getElementById('publicChatInput');
      const text = input.value.trim();

      if (!text) return;

      const messageRef = db.ref('publicChat').push();
      messageRef.set({
        text: text,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || 'Utilisateur',
        authorProfilePicture: currentUser.photoURL || 'https://via.placeholder.com/36',
        timestamp: Date.now()
      });

      input.value = '';
    }

    // Load private chat
    function loadPrivateChat() {
      // Load contacts
      const usersRef = db.ref('users');
      usersRef.on('value', (snapshot) => {
        const users = snapshot.val();
        const contactsList = document.getElementById('contactsList');
        contactsList.innerHTML = '';

        if (!users) return;

        Object.entries(users).forEach(([userId, user]) => {
          if (userId === currentUser.uid) return;

          const contactElement = document.createElement('div');
          contactElement.className = 'contact';
          contactElement.innerHTML = `
            <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" 
                 alt="Profile" class="contact-avatar">
            <div class="contact-info">
              <div class="contact-name">${escapeHtml(user.name)}</div>
              <div class="contact-status">
                <i class="fas fa-circle status-online"></i>
                En ligne
              </div>
            </div>
          `;
          contactElement.addEventListener('click', () => {
            selectContact(userId, user);
          });
          contactsList.appendChild(contactElement);
        });

        document.getElementById('contactCount').textContent = Object.keys(users).length - 1;
      });
    }

    // Select contact for private chat
    function selectContact(contactId, contact) {
      currentChatContact = { id: contactId, ...contact };
      
      // Update UI
      document.querySelectorAll('.contact').forEach(c => c.classList.remove('active'));
      event.currentTarget.classList.add('active');

      // Load chat messages
      loadPrivateMessages(contactId);
    }

    // Load private messages
    function loadPrivateMessages(contactId) {
      const chatId = [currentUser.uid, contactId].sort().join('_');
      const messagesRef = db.ref(`privateChat/${chatId}`).orderByChild('timestamp');
      
      messagesRef.on('value', (snapshot) => {
        const messages = snapshot.val();
        const messagesContainer = document.getElementById('privateChatMessages');
        messagesContainer.innerHTML = '';

        if (!messages) return;

        Object.entries(messages).forEach(([messageId, message]) => {
          renderPrivateMessage(messageId, message);
        });

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Render private message
    function renderPrivateMessage(messageId, message) {
      const messagesContainer = document.getElementById('privateChatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = `message ${message.senderId === currentUser.uid ? 'own' : ''}`;
      messageElement.innerHTML = `
        <img src="${message.senderProfilePicture || 'https://via.placeholder.com/36'}" 
             alt="Profile" class="message-avatar">
        <div class="message-content">
          <div class="message-header">
            <span class="message-author">${escapeHtml(message.senderName)}</span>
            <span class="message-time">${formatTime(message.timestamp)}</span>
          </div>
          <div class="message-text">${escapeHtml(message.text)}</div>
        </div>
      `;
      messagesContainer.appendChild(messageElement);
    }

    // Handle private chat message
    function handlePrivateChat(e) {
      e.preventDefault();
      
      if (!currentUser || !currentChatContact) {
        alert('Veuillez sélectionner un contact');
        return;
      }

      const input = document.getElementById('privateChatInput');
      const text = input.value.trim();

      if (!text) return;

      const chatId = [currentUser.uid, currentChatContact.id].sort().join('_');
      const messageRef = db.ref(`privateChat/${chatId}`).push();
      
      messageRef.set({
        text: text,
        senderId: currentUser.uid,
        senderName: currentUser.displayName || 'Utilisateur',
        senderProfilePicture: currentUser.photoURL || 'https://via.placeholder.com/36',
        receiverId: currentChatContact.id,
        timestamp: Date.now()
      });

      // Create notification for receiver
      const notificationRef = db.ref(`notifications/${currentChatContact.id}`).push();
      notificationRef.set({
        type: 'message',
        fromUserId: currentUser.uid,
        fromUserName: currentUser.displayName || 'Utilisateur',
        text: `Nouveau message de ${currentUser.displayName || 'Utilisateur'}`,
        timestamp: Date.now(),
        read: false
      });

      input.value = '';
    }

    // Load notifications
    function loadNotifications() {
      if (!currentUser) return;

      const notificationsRef = db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp');
      notificationsRef.on('value', (snapshot) => {
        const notifications = snapshot.val();
        const notificationsList = document.getElementById('notificationsList');
        const notificationCount = document.getElementById('notificationCount');
        
        notificationsList.innerHTML = '';
        let unreadCount = 0;

        if (!notifications) {
          notificationsList.innerHTML = '<p>Aucune notification</p>';
          notificationCount.textContent = '0';
          return;
        }

        Object.entries(notifications).forEach(([notificationId, notification]) => {
          if (!notification.read) unreadCount++;
          
          const notificationElement = document.createElement('div');
          notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
          notificationElement.innerHTML = `
            <div class="notification-icon">
              <i class="fas fa-comment"></i>
            </div>
            <div class="notification-content">
              <div class="notification-text">${escapeHtml(notification.text)}</div>
              <div class="notification-time">${formatTime(notification.timestamp)}</div>
            </div>
          `;
          notificationElement.addEventListener('click', () => {
            markNotificationAsRead(notificationId);
          });
          notificationsList.appendChild(notificationElement);
        });

        notificationCount.textContent = unreadCount;
      });
    }

    // Mark notification as read
    function markNotificationAsRead(notificationId) {
      if (!currentUser) return;

      const notificationRef = db.ref(`notifications/${currentUser.uid}/${notificationId}`);
      notificationRef.update({
        read: true
      });
    }

    // Setup realtime listeners
    function setupRealtimeListeners() {
      if (!currentUser) return;

      // Set user as online
      const onlineRef = db.ref(`onlineUsers/${currentUser.uid}`);
      onlineRef.set({
        name: currentUser.displayName || 'Utilisateur',
        lastSeen: Date.now()
      });

      // Remove user from online when they disconnect
      onlineRef.onDisconnect().remove();

      // Listen for new notifications
      const notificationsRef = db.ref(`notifications/${currentUser.uid}`).orderByChild('read').equalTo(false);
      notificationsRef.on('child_added', (snapshot) => {
        // Show browser notification if permitted
        if (Notification.permission === 'granted') {
          const notification = snapshot.val();
          new Notification('Mikotse', {
            body: notification.text,
            icon: '/icon.png'
          });
        }
      });
    }

    // Admin functions
    function showAdminLogin() {
      showPage('adminPage');
    }

    function loadAdminData() {
      loadPendingPayments();
      loadAdminVideos();
    }

    function loadPendingPayments() {
      const paymentsRef = db.ref('payments').orderByChild('status').equalTo('pending');
      paymentsRef.on('value', (snapshot) => {
        const payments = snapshot.val();
        const paymentsTable = document.getElementById('paymentsTable');
        paymentsTable.innerHTML = '';

        if (!payments) {
          paymentsTable.innerHTML = '<tr><td colspan="6">Aucun paiement en attente</td></tr>';
          return;
        }

        Object.entries(payments).forEach(([paymentId, payment]) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHtml(payment.userName)}</td>
            <td>${escapeHtml(payment.plan)}</td>
            <td>${payment.amount} Ar</td>
            <td><span class="status-badge status-pending">En attente</span></td>
            <td>${formatTime(payment.createdAt)}</td>
            <td>
              <button class="auth-btn" onclick="confirmPayment('${paymentId}', '${payment.userId}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                Confirmer
              </button>
            </td>
          `;
          paymentsTable.appendChild(row);
        });
      });
    }

    function confirmPayment(paymentId, userId) {
      const paymentRef = db.ref('payments/' + userId);
      paymentRef.update({
        status: 'confirmed',
        confirmedAt: Date.now(),
        confirmedBy: 'admin'
      }).then(() => {
        alert('Paiement confirmé avec succès!');
        
        // Create notification for user
        const notificationRef = db.ref(`notifications/${userId}`).push();
        notificationRef.set({
          type: 'payment',
          text: 'Votre paiement a été confirmé. Vous pouvez maintenant accéder à la plateforme.',
          timestamp: Date.now(),
          read: false
        });
      });
    }

    // Handle add video
    function handleAddVideo(e) {
      e.preventDefault();
      
      const title = document.getElementById('videoTitle').value;
      const url = document.getElementById('videoUrl').value;
      const downloadUrl = document.getElementById('videoDownloadUrl').value;
      const registrationUrl = document.getElementById('videoRegistrationUrl').value;
      const description = document.getElementById('videoDescription').value;
      const category = document.getElementById('videoCategory').value;

      const videoRef = db.ref('videos').push();
      videoRef.set({
        title: title,
        url: url,
        downloadUrl: downloadUrl,
        registrationUrl: registrationUrl,
        description: description,
        category: category,
        createdAt: Date.now(),
        addedBy: 'admin'
      }).then(() => {
        alert('Vidéo ajoutée avec succès!');
        document.getElementById('videoForm').reset();
        loadAdminVideos();
      });
    }

    function loadAdminVideos() {
      const videosRef = db.ref('videos').orderByChild('createdAt');
      videosRef.on('value', (snapshot) => {
        const videos = snapshot.val();
        const adminVideosList = document.getElementById('adminVideosList');
        adminVideosList.innerHTML = '';

        if (!videos) {
          adminVideosList.innerHTML = '<p>Aucune vidéo disponible</p>';
          return;
        }

        Object.entries(videos).forEach(([videoId, video]) => {
          const videoElement = document.createElement('div');
          videoElement.style.padding = '1rem';
          videoElement.style.borderBottom = '1px solid var(--border)';
          videoElement.innerHTML = `
            <h5>${escapeHtml(video.title)}</h5>
            <p>${escapeHtml(video.description || '')}</p>
            <div style="margin: 0.5rem 0;">
              ${video.downloadUrl ? `<div><strong>Lien téléchargement:</strong> ${video.downloadUrl}</div>` : ''}
              ${video.registrationUrl ? `<div><strong>Lien inscription:</strong> ${video.registrationUrl}</div>` : ''}
            </div>
            <small>Ajouté le ${formatTime(video.createdAt)}</small>
            <button class="auth-btn" onclick="deleteVideo('${videoId}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-top: 0.5rem;">
              Supprimer
            </button>
          `;
          adminVideosList.appendChild(videoElement);
        });
      });
    }

    function deleteVideo(videoId) {
      if (confirm('Êtes-vous sûr de vouloir supprimer cette vidéo?')) {
        const videoRef = db.ref('videos/' + videoId);
        videoRef.remove().then(() => {
          alert('Vidéo supprimée avec succès!');
        });
      }
    }

    // Edit profile
    function editProfile() {
      showSection('profile');
    }

    // Logout
    function logout() {
      auth.signOut().then(() => {
        currentUser = null;
        showPage('loginPage');
      });
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format timestamp to readable time
    function formatTime(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      
      if (diffMins < 1) return 'Maintenant';
      if (diffMins < 60) return `Il y a ${diffMins} min`;
      if (diffHours < 24) return `Il y a ${diffHours} h`;
      
      return time.toLocaleDateString();
    }

    // Request notification permission
    if ('Notification' in window) {
      Notification.requestPermission();
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>